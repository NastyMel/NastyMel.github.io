<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Найди числа Фибоначчи!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Подключаем p5.js и p5.dom -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.dom.min.js"></script>
  <!-- Подключаем шрифт Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      font-family: 'Roboto', sans-serif;
      position: relative;
    }
    #header {
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      width: 100%;
      max-width: 500px;
      margin: 20px auto 10px auto;
      padding: 10px;
      color: #fff;
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #status {
      font-size: 16px;
      text-align: center;
      width: 100%;
      max-width: 500px;
      margin: 10px auto;
      color: #333;
      background-color: rgba(255,255,255,0.9);
      border-radius: 6px;
      padding: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    canvas {
      display: block;
      margin: 0 auto;
      border: none;
      border-radius: 8px;
      width: 95%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .ui-buttons {
      margin: 10px auto;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .ui-buttons button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #2575fc;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    .ui-buttons button:hover {
      background-color: #6a11cb;
    }
    #leaderboard {
      font-size: 16px;
      text-align: center;
      width: 100%;
      max-width: 500px;
      margin: 10px auto 20px auto;
      color: #fff;
      background: linear-gradient(45deg, #11998e, #38ef7d);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    /* Стиль контейнера и кнопки старта игры */
    #startContainer {
      position: absolute;
      top: 10px;
      left: 0;
      right: 0;
      z-index: 100;
      text-align: center;
    }
    #startButton {
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #2575fc;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    #startButton:hover {
      background-color: #6a11cb;
    }
    @media (max-width: 600px) {
      #header { font-size: 28px; }
      #status { font-size: 14px; }
      .ui-buttons button { font-size: 14px; padding: 8px 16px; }
      #leaderboard { font-size: 14px; }
      #startButton { font-size: 16px; padding: 8px 16px; }
    }
  </style>
</head>
<body>
<div id="startContainer">
  <button id="startButton">Начать игру</button>
</div>
<script type="module">
  const generateFibo = (max) => {
    const fibo = [1];
    let a = 1, b = 1;
    while (b <= max) {
      if (!fibo.includes(b)) {
        fibo.push(b);
      }
      const next = a + b;
      a = b;
      b = next;
    }
    return fibo;
  };

  const shuffleArray = (array) => {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(random(i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  };

  class Cell {
    constructor(x, y, w, h, number, isFibo) {
      this.x = x;
      this.y = y;
      this.w = w;
      this.h = h;
      this.number = number;
      this.isFibo = isFibo;
      this.clicked = false;
    }
    draw() {
      stroke(200);
      strokeWeight(1);
      fill(this.clicked ? (this.isFibo ? '#38ef7d' : '#ff4d4d') : 255);
      rect(this.x, this.y, this.w, this.h, 5);
      fill(50);
      noStroke();
      textAlign(CENTER, CENTER);
      textSize(20);
      text(this.number, this.x + this.w / 2, this.y + this.h / 2);
    }
    contains(mx, my) {
      return (mx >= this.x && mx <= this.x + this.w &&
              my >= this.y && my <= this.y + this.h);
    }
  }

  class DecoyCell {
    constructor(x, y, w, h) {
      this.x = x;
      this.y = y;
      this.w = w;
      this.h = h;
      this.baseColor = color(220, 220, 255, 150);
      this.vx = random(-1, 1);
      this.vy = random(-1, 1);
    }
    update() {
      this.x += this.vx;
      this.y += this.vy;
      if (this.x < 0 || this.x + this.w > width) this.vx *= -1;
      if (this.y < 0 || this.y + this.h > height) this.vy *= -1;
    }
    draw() {
      noStroke();
      fill(this.baseColor);
      rect(this.x, this.y, this.w, this.h, 5);
    }
  }

  class UI {
    constructor(game) {
      this.game = game;
      this.header = createDiv("Найди числа Фибоначчи!").id("header");
      this.status = createDiv("").id("status");
      this.buttonsContainer = createDiv().class("ui-buttons");
      this.pauseButton = createButton("Пауза");
      this.pauseButton.parent(this.buttonsContainer);
      this.pauseButton.mousePressed(() => {
        game.togglePause();
        this.updatePauseButtonLabel();
      });
      this.restartButton = createButton("Рестарт");
      this.restartButton.parent(this.buttonsContainer);
      this.restartButton.mousePressed(() => {
        game.reset();
        this.updatePauseButtonLabel();
      });
      this.leaderboardDiv = createDiv("").id("leaderboard");
      this.displayLeaderboard();
    }
    updatePauseButtonLabel() {
      this.pauseButton.html(this.game.paused ? "Возобновить" : "Пауза");
    }
    updateStatus() {
      if (!this.game.gameStarted) {
        this.status.html("Игра не запущена");
      } else if (this.game.gameEnded) {
        this.status.html(`Поздравляем!<br>Ваш результат: ${this.game.points} очков`);
        if (!this.game.leaderboardUpdated) {
          this.updateLeaderboard(this.game.points);
          this.game.leaderboardUpdated = true;
        }
      } else {
        const remaining = (this.game.timeLimit - (millis() - this.game.gameStartTime) / 1000).toFixed(1);
        this.status.html(`Время: ${remaining} сек &nbsp;&nbsp; Очки: ${this.game.points} &nbsp;&nbsp; Мультипликатор: x${this.game.multiplier}`);
      }
    }
    updateLeaderboard(newScore) {
      let leaderboard = JSON.parse(localStorage.getItem("fiboLeaderboard")) || [];
      leaderboard.push(parseFloat(newScore));
      leaderboard.sort((a, b) => b - a);
      if (leaderboard.length > 5) leaderboard = leaderboard.slice(0, 5);
      localStorage.setItem("fiboLeaderboard", JSON.stringify(leaderboard));
      this.displayLeaderboard();
    }
    displayLeaderboard() {
      let leaderboard = JSON.parse(localStorage.getItem("fiboLeaderboard")) || [];
      if (leaderboard.length === 0) {
        this.leaderboardDiv.html("Доска рекордов пуста");
      } else {
        let html = "<strong>Доска рекордов (очки):</strong><br>";
        leaderboard.forEach((score, index) => {
          html += `${index + 1}. ${score}<br>`;
        });
        this.leaderboardDiv.html(html);
      }
    }
    draw() {
      this.updateStatus();
    }
  }

  class Game {
    constructor(width, height, cols = 5, rows = 5) {
      this.width = width;
      this.height = height;
      this.cols = cols;
      this.rows = rows;
      this.cellWidth = this.width / this.cols;
      this.cellHeight = this.height / this.rows;
      this.cells = [];
      this.gameStarted = false;
      this.gameEnded = false;
      this.paused = false;
      this.timeLimit = 60;
      this.gameStartTime = 0;
      this.chain = 0;
      this.multiplier = 1;
      this.points = 0;
      this.errorCount = 0;
      this.errorThreshold = 3;
      this.maxNumber = 100;
      this.fiboNumbers = generateFibo(this.maxNumber);
      this.fiboCellsCount = 0;
      this.shakeTime = 0;
      this.leaderboardUpdated = false;
      this.decoyCells = [];
    }
    init() {
      this.cells = [];
      this.decoyCells = [];
      this.gameStarted = false;
      this.gameEnded = false;
      this.paused = false;
      this.chain = 0;
      this.multiplier = 1;
      this.points = 0;
      this.errorCount = 0;
      this.gameStartTime = millis();
      this.leaderboardUpdated = false;
      const totalCells = this.cols * this.rows;
      this.fiboCellsCount = Math.floor(totalCells * 0.4);
      const indices = Array.from({ length: totalCells }, (_, i) => i);
      shuffleArray(indices);
      const fiboIndices = indices.slice(0, this.fiboCellsCount);
      for (let r = 0; r < this.rows; r++) {
        for (let c = 0; c < this.cols; c++) {
          const idx = r * this.cols + c;
          const x = c * this.cellWidth;
          const y = r * this.cellHeight;
          const isFiboCell = fiboIndices.includes(idx);
          let number;
          if (isFiboCell) {
            number = random(this.fiboNumbers);
          } else {
            do {
              number = Math.floor(random(1, this.maxNumber + 1));
            } while (this.fiboNumbers.includes(number));
          }
          this.cells.push(new Cell(x, y, this.cellWidth, this.cellHeight, number, isFiboCell));
        }
      }
    }
    start() {
      console.log("Игра запущена");
      this.gameStarted = true;
      this.gameStartTime = millis();
    }
    togglePause() {
      if (!this.gameStarted) return;
      this.paused = !this.paused;
      this.paused ? noLoop() : loop();
    }
    reset() {
      this.init();
      this.start();
      loop();
    }
    update() {
      if (this.shakeTime > 0) {
        const shakeMagnitude = 5;
        const dx = random(-shakeMagnitude, shakeMagnitude);
        const dy = random(-shakeMagnitude, shakeMagnitude);
        translate(dx, dy);
        this.shakeTime -= deltaTime;
      }
      for (const cell of this.cells) {
        cell.draw();
      }
      for (const decoy of this.decoyCells) {
        decoy.update();
        decoy.draw();
      }
      const elapsed = (millis() - this.gameStartTime) / 1000;
      if (this.timeLimit - elapsed <= 0) {
        this.gameEnded = true;
      }
    }
    triggerShake() {
      this.shakeTime = 200;
    }
    modifyLayout() {
      if (this.cols < 8 && this.rows < 8) {
        this.cols += 1;
        this.rows += 1;
        this.cellWidth = this.width / this.cols;
        this.cellHeight = this.height / this.rows;
      }
      const numDecoys = 3;
      for (let i = 0; i < numDecoys; i++) {
        const w = this.cellWidth * 0.8;
        const h = this.cellHeight * 0.8;
        const x = random(0, this.width - w);
        const y = random(0, this.height - h);
        this.decoyCells.push(new DecoyCell(x, y, w, h));
      }
    }
    handleInteraction(x, y) {
      if (!this.gameStarted || this.gameEnded || this.paused) return;
      let cellClicked = false;
      for (const cell of this.cells) {
        if (!cell.clicked && cell.contains(x, y)) {
          cell.clicked = true;
          cellClicked = true;
          if (cell.isFibo) {
            this.chain++;
            this.multiplier = 1 + this.chain * 0.5;
            this.points += Math.floor(10 * this.multiplier);
          } else {
            this.chain = 0;
            this.multiplier = 1;
            this.errorCount++;
            this.gameStartTime -= 5000;
            this.triggerShake();
            if (this.errorCount >= this.errorThreshold) {
              this.modifyLayout();
              this.errorCount = 0;
            }
          }
          break;
        }
      }
      if (!cellClicked) {
        this.chain = 0;
        this.multiplier = 1;
        this.gameStartTime -= 3000;
        this.triggerShake();
      }
    }
  }

  let game, ui;
  window.setup = () => {
    const canvasSize = Math.min(windowWidth * 0.95, 500);
    const cnv = createCanvas(canvasSize, canvasSize);
    cnv.parent(document.body);
    game = new Game(canvasSize, canvasSize, 5, 5);
    game.init();
    ui = new UI(game);
  };

  window.draw = () => {
    background(245, 247, 250);
    push();
      game.update();
    pop();
    ui.draw();
  };

  window.mousePressed = () => {
    game.handleInteraction(mouseX, mouseY);
  };

  window.touchStarted = () => {
    if (touches.length > 0) {
      const touchPoint = touches[0];
      game.handleInteraction(touchPoint.x, touchPoint.y);
    }
    return false;
  };

  window.windowResized = () => {
    const canvasSize = Math.min(windowWidth * 0.95, 500);
    resizeCanvas(canvasSize, canvasSize);
  };

  // Обработка клика по кнопке для старта игры
  const startButton = document.getElementById('startButton');
  const startContainer = document.getElementById('startContainer');
  const startGame = () => {
    console.log("Нажата кнопка запуска");
    startContainer.style.display = 'none';
    game.start();
  };

  startButton.addEventListener('click', startGame);
  startButton.addEventListener('touchend', (e) => {
    e.preventDefault();
    startGame();
  });
</script>
</body>
</html>
